---
- name: Flush iptables rules before deployment
  command: iptables -F
  become: yes
  ignore_errors: yes

- name: clean up the dt_path
  file:
    path: "{{ dt_path }}"
    state: absent

- name: clone architecture repo
  git:
    repo: https://github.com/masco/architecture.git
    dest: "{{ dt_path }}"
    version: bm-ocp
    force: yes

- name: download kustomize lib
  shell:
    curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh"  | bash

- name: move the kustomize to usr-bin
  shell:
    mv kustomize /usr/bin/.

- name: Download or load OCP inventory
  include_tasks: includes/download_ocp_inventory.yml

- name: enable ip forward for ovn-kubernets
  shell: |
    oc patch network.operator cluster -p '{"spec":{"defaultNetwork": {"ovnKubernetesConfig":{"gatewayConfig":{"ipForwarding": "Global"}}}}}' --type=merge

- name: Setup observability operator
  block:
    - name: Copy observability operator subscription template
      template:
        src: subscriptions.yaml
        dest: "{{ dt_path }}/subscriptions.yaml"

    - name: Apply observability operator subscription
      shell: |
        oc apply -f {{ dt_path }}/subscriptions.yaml

    - name: Wait for observability operator to be available
      shell: |
        oc wait deployments/observability-operator --for condition=Available --timeout=300s -n openshift-operators
  when: telemetry | default(true)